<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="sale_stone_selection.StoneGrid" owl="1">
        <div class="o_stone_selection_panel">
            
            <!-- Loading State -->
            <div t-if="state.isLoading" class="p-4 text-center text-muted">
                <i class="fa fa-circle-o-notch fa-spin me-2"/> Buscando material disponible...
            </div>

            <!-- Empty State -->
            <div t-elif="state.details.length === 0" class="p-3">
                <div class="alert alert-warning mb-0 d-flex align-items-center">
                    <i class="fa fa-exclamation-triangle me-2"/>
                    <span>No se encontró stock disponible en ubicaciones internas para este producto.</span>
                </div>
            </div>

            <!-- Data Grid -->
            <div t-else="" class="stone-grid-wrapper">
                <table class="table table-sm table-hover o_stone_table mb-0">
                    <thead>
                        <tr>
                            <th class="text-center col-check"><i class="fa fa-check-square-o"/></th>
                            <th class="col-lot">Lote</th>
                            <th class="col-loc">Ubicación</th>
                            <th class="col-dims text-end">Dimensiones</th>
                            <th class="col-qty text-end">M²</th>
                            <th class="col-block">Bloque</th>
                            <th class="col-type">Tipo</th>
                            <th class="col-color">Color</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="groupedDetails" t-as="group" t-key="group.blockName">
                            <!-- Header de Grupo (Bloque) -->
                            <tr class="group-header-row">
                                <td colspan="8">
                                    <div class="d-flex justify-content-between align-items-center px-2">
                                        <span class="fw-bold text-primary">
                                            <i class="fa fa-cubes me-1"/> Bloque: <t t-esc="group.blockName"/>
                                        </span>
                                        <div class="badge bg-light text-dark border">
                                            Total: <t t-esc="formatNum(group.totalArea)"/> m² 
                                            (<t t-esc="group.count"/> pzas)
                                        </div>
                                    </div>
                                </td>
                            </tr>

                            <!-- Items -->
                            <t t-foreach="group.items" t-as="detail" t-key="detail.id">
                                <tr t-on-click="() => this.toggleSelection(detail)" 
                                    t-att-class="isSelected(detail) ? 'row-selected' : ''"
                                    class="stone-item-row">
                                    
                                    <td class="text-center position-relative">
                                        <input type="checkbox" 
                                               t-att-checked="isSelected(detail)"
                                               class="form-check-input stone-checkbox"/>
                                    </td>
                                    
                                    <td class="fw-bold text-dark font-monospace">
                                        <t t-esc="detail.lot_name"/>
                                    </td>
                                    
                                    <td class="text-muted small">
                                        <i class="fa fa-map-marker me-1 text-info"/>
                                        <t t-esc="detail.location_name"/>
                                    </td>
                                    
                                    <td class="text-end font-monospace small">
                                        <t t-if="detail.alto and detail.ancho">
                                            <t t-esc="detail.alto"/> × <t t-esc="detail.ancho"/>
                                        </t>
                                        <t t-else="">-</t>
                                    </td>
                                    
                                    <td class="text-end fw-bold">
                                        <span class="badge bg-white text-dark border">
                                            <t t-esc="formatNum(detail.quantity)"/>
                                        </span>
                                    </td>
                                    
                                    <td class="text-muted small"><t t-esc="detail.bloque"/></td>
                                    <td class="text-muted small"><t t-esc="detail.tipo"/></td>
                                    <td class="text-muted small"><t t-esc="detail.color"/></td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>
            </div>
            
            <!-- Footer Informativo -->
            <div class="p-2 bg-light border-top d-flex justify-content-between align-items-center small text-muted">
                <span><i class="fa fa-info-circle me-1"/> Selecciona las placas para actualizar la cantidad.</span>
                <span><t t-esc="state.selectedLotIds.size"/> placas seleccionadas</span>
            </div>
        </div>
    </t>
</templates>
