<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- 1. Template del Botón (Widget) -->
    <t t-name="sale_stone_selection.ExpandButton" owl="1">
        <div class="o_stone_toggle_btn cursor-pointer" t-on-click="toggle">
            <i class="fa fa-chevron-right" 
               t-att-class="{'o_rotated': props.record.data.is_stone_expanded}"/>
        </div>
    </t>

    <!-- 2. Override del Renderer -->
    <t t-name="sale_stone_selection.ListRenderer" t-inherit="web.ListRenderer" t-inherit-mode="primary">
        <xpath expr="//table/tbody" position="replace">
            <tbody>
                <t t-foreach="rows" t-as="row" t-key="row.id">
                    <!-- 
                        Fila Estándar de Odoo:
                        Al no heredarla, usamos la original <ListRow>.
                        El botón aparecerá porque añadiremos el campo en la vista.
                    -->
                    <ListRow 
                        t-props="row" 
                        list="list" 
                        onRowClicked="onRowClicked"
                    />
                    
                    <!-- Fila Expandible (Stone Grid) -->
                    <t t-if="row.record.data.product_id and row.record.data.is_stone_expanded">
                         <tr class="o_stone_details_row_tr">
                             <!-- Usamos una función del renderer para el colspan -->
                             <td t-att-colspan="getColspan(row)" class="p-0 border-0">
                                 <div class="o_stone_slide_down">
                                     <StoneGrid 
                                         productId="row.record.data.product_id[0]"
                                         selectedLotIds="row.record.data.lot_ids.currentIds"
                                         onUpdateSelection.bind="(ids) => updateLotSelection(row, ids)"
                                     />
                                 </div>
                             </td>
                         </tr>
                    </t>
                </t>
            </tbody>
        </xpath>
    </t>

</templates>