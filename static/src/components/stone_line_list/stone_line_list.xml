<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- 1. Template del Bot칩n (Widget) -->
    <t t-name="sale_stone_selection.ExpandButton" owl="1">
        <div class="o_stone_toggle_btn cursor-pointer text-center" t-on-click="toggle">
            <i class="fa fa-chevron-right" 
               t-att-class="{'o_rotated': props.record.data.is_stone_expanded}"
               title="Ver detalles"/>
        </div>
    </t>

    <!-- 2. Override del Renderer -->
    <t t-name="sale_stone_selection.ListRenderer" t-inherit="web.ListRenderer" t-inherit-mode="primary">
        <xpath expr="//table/tbody" position="replace">
            <!-- IMPORTANTE: t-ref="tbody" es necesario para que Odoo reconozca la lista -->
            <tbody t-ref="tbody">
                <t t-foreach="rows" t-as="row" t-key="row.id">
                    <!-- Fila Est치ndar -->
                    <ListRow 
                        t-props="row" 
                        list="list" 
                        onRowClicked="onRowClicked"
                    />
                    
                    <!-- Fila Expandible (Se muestra si el campo boolean es true) -->
                    <t t-if="row.record.data.product_id and row.record.data.is_stone_expanded">
                         <tr class="o_stone_details_row_tr">
                             <!-- Usamos una funci칩n segura para el colspan -->
                             <td t-att-colspan="getColspanSafe()" class="p-0 border-0">
                                 <div class="o_stone_slide_down">
                                     <!-- Verificaci칩n de seguridad para product_id -->
                                     <StoneGrid 
                                         productId="row.record.data.product_id[0]"
                                         selectedLotIds="row.record.data.lot_ids.currentIds"
                                         onUpdateSelection.bind="(ids) => updateLotSelection(row, ids)"
                                     />
                                 </div>
                             </td>
                         </tr>
                    </t>
                </t>
            </tbody>
        </xpath>
    </t>

</templates>