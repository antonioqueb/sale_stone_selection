<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- 1. Override del Renderer Loop -->
    <t t-name="sale_stone_selection.ListRenderer" t-inherit="web.ListRenderer" t-inherit-mode="primary">
        <xpath expr="//table/tbody" position="replace">
            <tbody>
                <t t-foreach="rows" t-as="row" t-key="row.id">
                    <!-- Fila Est치ndar de Odoo -->
                    <ListRow 
                        t-props="row" 
                        list="list" 
                        onRowClicked="onRowClicked"
                    />
                    
                    <!-- Fila Expandible (Stone Grid) -->
                    <!-- Solo se renderiza si hay producto y el flag 'is_stone_expanded' es true -->
                    <t t-if="row.record.data.product_id and row.record.data.is_stone_expanded">
                         <tr class="o_stone_details_row_tr">
                             <!-- Colspan din치mico para ocupar todo el ancho -->
                             <td t-att-colspan="columns.length + (hasSelectors ? 1 : 0) + 2" class="p-0 border-0">
                                 <div class="o_stone_slide_down">
                                     <StoneGrid 
                                         productId="row.record.data.product_id[0]"
                                         selectedLotIds="row.record.data.lot_ids.currentIds"
                                         onUpdateSelection.bind="(ids) => row.record.update({ lot_ids: [[6, 0, ids]] })"
                                     />
                                 </div>
                             </td>
                         </tr>
                    </t>
                </t>
            </tbody>
        </xpath>
    </t>

    <!-- 2. Override del Row para a침adir el bot칩n toggle -->
    <t t-name="sale_stone_selection.ListRow" t-inherit="web.ListRow" t-inherit-mode="primary">
        <xpath expr="//td[1]" position="inside">
            <t t-if="props.record.data.product_id">
                <div class="d-inline-block ms-1" t-on-click.stop="">
                    <button class="btn btn-sm btn-link p-0 text-decoration-none o_stone_toggle_btn"
                            t-on-click="() => props.record.update({ is_stone_expanded: !props.record.data.is_stone_expanded })"
                            title="Seleccionar placas">
                        <i class="fa fa-chevron-down" 
                           t-att-class="{'o_rotated': props.record.data.is_stone_expanded}"/>
                    </button>
                </div>
            </t>
        </xpath>
    </t>

</templates>
